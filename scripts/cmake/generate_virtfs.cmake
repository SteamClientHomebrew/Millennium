function(filename_to_identifier filename output_var)
    get_filename_component(name_without_ext "${filename}" NAME_WE)
    string(TOUPPER "${name_without_ext}" upper_name)
    string(REGEX REPLACE "[-.]" "_" clean_name "${upper_name}")
    if(filename MATCHES "\\.map$")
        set(${output_var} "MILLENNIUM_${clean_name}_MAP_" PARENT_SCOPE)
    else()
        set(${output_var} "MILLENNIUM_${clean_name}_BIN_" PARENT_SCOPE)
    endif()
endfunction()

file(GLOB CHUNK_FILES "${MILLENNIUM_BASE}/src/sdk/packages/loader/build/chunks/*")
set(HEADER_CONTENT "/**\n * Auto-generated by Millennium during CMake configuration - do not edit manually :)\n */\n")
set(HEADER_CONTENT "${HEADER_CONTENT}#pragma once\n\n")
set(RC_CONTENT "// Auto-generated resource file\n#include <windows.h>\n\n")

if(CMAKE_BUILD_TYPE STREQUAL "Release")
    set(HEADER_CONTENT "${HEADER_CONTENT}#ifdef _WIN32\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#include <windows.h>\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#include <string>\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#include \"millennium/logger.h\"\n\n")  # for LOG_ERROR
    set(HEADER_CONTENT "${HEADER_CONTENT}inline std::string LoadResourceData(const char* name) {\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}    HMODULE hModule = nullptr;\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}    GetModuleHandleExA(GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS, reinterpret_cast<LPCSTR>(&LoadResourceData), &hModule);\n\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}    HRSRC hRes = FindResourceA(hModule, name, RT_RCDATA);\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}    if (!hRes) {\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}        LOG_ERROR(\"Failed to find internal resource '{}'\", name);\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}        return {};\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}    }\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}    HGLOBAL hData = LoadResource(hModule, hRes);\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}    if (!hData) {\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}        LOG_ERROR(\"Failed to load internal resource '{}'\", name);\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}        return {};\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}    }\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}    DWORD size = SizeofResource(hModule, hRes);\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}    const char* data = static_cast<const char*>(LockResource(hData));\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}    return std::string(data, size);\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}}\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#else\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#define INCBIN_PREFIX\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#include \"incbin.h\"\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#endif\n\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}/** Millennium frontend library */\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#ifdef _WIN32\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#define MILLENNIUM_FRONTEND_BIN_Data LoadResourceData(\"MILLENNIUM_FRONTEND_BIN\")\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#else\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}INCTXT(MILLENNIUM_FRONTEND_BIN_, \"${MILLENNIUM_BASE}/build/frontend.bin\");\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#endif\n\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}/** Millennium API library */\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#ifdef _WIN32\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#define MILLENNIUM_API_BIN_Data LoadResourceData(\"MILLENNIUM_API_BIN\")\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#else\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}INCTXT(MILLENNIUM_API_BIN_, \"${MILLENNIUM_BASE}/src/sdk/packages/loader/build/millennium.js\");\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}#endif\n\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}/** Millennium API chunk files */\n")
    set(RC_CONTENT "${RC_CONTENT}MILLENNIUM_FRONTEND_BIN RCDATA \"${MILLENNIUM_BASE}/build/frontend.bin\"\n")
    set(RC_CONTENT "${RC_CONTENT}MILLENNIUM_API_BIN RCDATA \"${MILLENNIUM_BASE}/src/sdk/packages/loader/build/millennium.js\"\n\n")
endif()

set(MAP_ENTRIES "")
set(CHUNK_DEFS "")

foreach(chunk_file ${CHUNK_FILES})
    get_filename_component(filename "${chunk_file}" NAME)
    if(filename MATCHES "\\.map$")
        continue()
    endif()
    file(RELATIVE_PATH rel_path "${MILLENNIUM_BASE}" "${chunk_file}")
    filename_to_identifier("${filename}" var_name)

    if(CMAKE_BUILD_TYPE STREQUAL "Release")
        set(CHUNK_DEFS "${CHUNK_DEFS}#ifdef _WIN32\n")
        set(CHUNK_DEFS "${CHUNK_DEFS}#define ${var_name}Data LoadResourceData(\"${var_name}\")\n")
        set(CHUNK_DEFS "${CHUNK_DEFS}#else\n")
        set(CHUNK_DEFS "${CHUNK_DEFS}INCTXT(${var_name}, \"../../../${rel_path}\");\n")
        set(CHUNK_DEFS "${CHUNK_DEFS}#endif\n\n")

        set(MAP_ENTRIES "${MAP_ENTRIES}\t{ fmt::format(\"https://millennium.ftp/{}/chunks/${filename}\", GetScrambledApiPathToken()), []() { return ${var_name}Data; } },\n")
        set(RC_CONTENT "${RC_CONTENT}${var_name} RCDATA \"${chunk_file}\"\n")
    else()
        set(MAP_ENTRIES "${MAP_ENTRIES}\t{ fmt::format(\"https://millennium.ftp/{}/chunks/${filename}\", GetScrambledApiPathToken()), []() { return SystemIO::ReadFileSync(MILLENNIUM_ROOT \"/${rel_path}\"); } },\n")
    endif()
endforeach()

set(HEADER_CONTENT "${HEADER_CONTENT}${CHUNK_DEFS}\n")
set(HEADER_CONTENT "${HEADER_CONTENT}// clang-format off\n")
set(HEADER_CONTENT "${HEADER_CONTENT}std::unordered_map<std::string, std::function<const std::string()>> INTERNAL_FTP_CALL_DATA = {\n")

if(CMAKE_BUILD_TYPE STREQUAL "Release")
    set(HEADER_CONTENT "${HEADER_CONTENT}\t{ fmt::format(\"https://millennium.ftp/{}/millennium-frontend.js\", GetScrambledApiPathToken()), []() { return MILLENNIUM_FRONTEND_BIN_Data; } },\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}\t{ fmt::format(\"https://millennium.ftp/{}/millennium.js\", GetScrambledApiPathToken()), []() { return MILLENNIUM_API_BIN_Data; } },\n")
else()
    set(HEADER_CONTENT "${HEADER_CONTENT}\t{ fmt::format(\"https://millennium.ftp/{}/millennium-frontend.js\", GetScrambledApiPathToken()), []() { return SystemIO::ReadFileSync(MILLENNIUM_ROOT \"/build/frontend.bin\"); } },\n")
    set(HEADER_CONTENT "${HEADER_CONTENT}\t{ fmt::format(\"https://millennium.ftp/{}/millennium.js\", GetScrambledApiPathToken()), []() { return SystemIO::ReadFileSync(MILLENNIUM_ROOT \"/src/sdk/packages/loader/build/millennium.js\"); } },\n")
endif()

set(HEADER_CONTENT "${HEADER_CONTENT}${MAP_ENTRIES}")
string(REGEX REPLACE ",\n$" "\n" HEADER_CONTENT "${HEADER_CONTENT}")
set(HEADER_CONTENT "${HEADER_CONTENT}};\n")
set(HEADER_CONTENT "${HEADER_CONTENT}// clang-format on\n")

file(MAKE_DIRECTORY "${MILLENNIUM_BASE}/src/include/millennium")
file(WRITE "${MILLENNIUM_BASE}/src/include/millennium/virtfs.h" "${HEADER_CONTENT}")

if(CMAKE_BUILD_TYPE STREQUAL "Release" AND WIN32)
    file(WRITE "${MILLENNIUM_BASE}/scripts/resources.rc" "${RC_CONTENT}")
endif()

add_custom_command(
    OUTPUT "${MILLENNIUM_BASE}/src/include/millennium/virtfs.h"
    COMMAND ${CMAKE_COMMAND} -P "${CMAKE_CURRENT_LIST_FILE}"
    DEPENDS ${CHUNK_FILES}
    COMMENT "Generating asset includes"
)
