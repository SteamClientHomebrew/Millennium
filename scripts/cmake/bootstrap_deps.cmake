set(CMAKE_POSITION_INDEPENDENT_CODE ON  CACHE BOOL     "Enable position independent code")
set(BUILD_SHARED_LIBS               OFF CACHE BOOL     "Build static libraries by default")
set(BUILD_STATIC_LIBS               ON  CACHE BOOL     "Build static libraries by default")

set(BUILD_TESTS                     OFF CACHE BOOL     "Disable building tests")
set(BUILD_EXAMPLES                  OFF CACHE BOOL     "Disable building examples")
set(CMAKE_CXX_STANDARD_REQUIRED     ON  CACHE BOOL     "Enforce C++ standard")
set(CMAKE_C_STANDARD_REQUIRED       ON  CACHE BOOL     "Enforce C standard")
set(USE_INTERNAL_FPCONV             ON  CACHE BOOL     "Use internal strtod() / g_fmt() code for performance")
set(NGHTTP2_STATICLIB               ON  CACHE BOOL     "Use static nghttp2 library")
set(BUILD_CURL_EXE                  OFF CACHE BOOL     "" FORCE)
set(CURL_USE_LIBSSH2                OFF CACHE BOOL     "" FORCE)
set(CURL_STATICLIB                  ON  CACHE BOOL     "Build curl as static library")
set(CURL_USE_SECTRANSP              OFF CACHE BOOL     "Disable SecureTransport")
set(CURL_USE_MBEDTLS                OFF CACHE BOOL     "Disable mbedTLS")
set(CURL_USE_WOLFSSL                OFF CACHE BOOL     "Disable wolfSSL")
set(CURL_USE_BEARSSL                OFF CACHE BOOL     "Disable BearSSL")
set(CURL_DISABLE_INSTALL            ON  CACHE BOOL     "Disable curl install")
set(CURL_DISABLE_LDAP               ON  CACHE BOOL     "Disable LDAP")
set(CURL_DISABLE_LDAPS              ON  CACHE BOOL     "Disable LDAPS")
set(CURL_DISABLE_RTSP               ON  CACHE BOOL     "Disable RTSP")
set(CURL_DISABLE_PROXY              OFF CACHE BOOL     "Disable proxy support")
set(CURL_DISABLE_DICT               ON  CACHE BOOL     "Disable DICT")
set(CURL_DISABLE_TELNET             ON  CACHE BOOL     "Disable TELNET")
set(CURL_DISABLE_TFTP               ON  CACHE BOOL     "Disable TFTP")
set(CURL_DISABLE_POP3               ON  CACHE BOOL     "Disable POP3")
set(CURL_DISABLE_IMAP               ON  CACHE BOOL     "Disable IMAP")
set(CURL_DISABLE_SMTP               ON  CACHE BOOL     "Disable SMTP")
set(CURL_DISABLE_GOPHER             ON  CACHE BOOL     "Disable Gopher")
set(CURL_USE_LIBPSL 		        OFF CACHE BOOL     "Disable libpsl")
set(FMT_HEADER_ONLY                 ON  CACHE BOOL     "Use fmt as header-only library")
set(FMT_DOC                         OFF CACHE BOOL     "Disable building documentation in fmt")
set(FMT_TEST                        OFF CACHE BOOL     "Disable building tests in fmt")
set(FMT_INSTALL                     ON  CACHE BOOL     "Enable installation of fmt")
set(MULTIPLE_THREADS 		        OFF CACHE BOOL     "Disable multithreading support in lua cjson")
set(BUILD_CLI  			            OFF CACHE BOOL     "Disable building CLI in libgit2")
set(MZ_BZIP2                        OFF CACHE BOOL     "Disable bzip2 support in minizip-ng")
set(MZ_FETCH_LIBS                   OFF CACHE BOOL     "Disable fetching third-party libs in minizip-ng")
set(MZ_ZLIB                         ON  CACHE BOOL     "Enable zlib support in minizip-ng")
set(USE_BUNDLED_ZLIB 		        OFF CACHE BOOL     "Use bundled zlib in libgit2")
set(USE_COMPRESSION 		        OFF CACHE BOOL     "Disable compression support in libgit2")
set(ZLIB_COMPAT                     ON  CACHE BOOL     "Enable zlib compatibility mode in zlib-ng")
set(ZLIB_ALIASES                    ON  CACHE BOOL     "Enable zlib alias symbols in zlib-ng")
set(ZLIB_ENABLE_TESTS               OFF CACHE BOOL     "Disable building tests in zlib-ng")
set(ZLIBNG_ENABLE_TESTS 	        OFF CACHE BOOL     "Disable building tests in zlib-ng")

if(WIN32)
    set(CURL_USE_SCHANNEL           ON  CACHE INTERNAL "" FORCE)
    set(CURL_WINDOWS_SSPI           ON  CACHE INTERNAL "" FORCE)
    set(CURL_USE_OPENSSL            OFF CACHE BOOL     "Use OpenSSL for TLS/SSL" FORCE)
else()
    set(CURL_USE_OPENSSL            ON  CACHE BOOL     "Use OpenSSL for TLS/SSL" FORCE)
    set(CURL_USE_SCHANNEL           OFF CACHE INTERNAL "" FORCE)
    set(CURL_WINDOWS_SSPI           OFF CACHE INTERNAL "" FORCE)
    set(REGEX_BACKEND               "builtin" CACHE STRING "Use builtin regex instead of PCRE" FORCE)
endif()


# Patch the minimum cmake version in a "submodule".
# Mingw decided they would force the new version of cmake which completely breaks older deps
# Only fix is a shim or fixing it up stream :shrug:

function(millennium_process_package input_path)
    if(EXISTS "${input_path}/CMakeLists.txt")
        file(READ "${input_path}/CMakeLists.txt" CMAKELISTS_CONTENTS)
        string(REGEX REPLACE "cmake_minimum_required[ \t]*\\([ \t]*VERSION[^)]*\\)" "cmake_minimum_required(VERSION 3.21)" CMAKELISTS_CONTENTS "${CMAKELISTS_CONTENTS}")
        file(WRITE "${input_path}/CMakeLists.txt" "${CMAKELISTS_CONTENTS}")
    else()
        message(WARNING "Could not find ${input_path} to patch.")
    endif()
endfunction()

message(STATUS "[Millennium] Fetching dependencies...")
set(FETCHCONTENT_QUIET OFF)

FetchContent_Declare(zlib          GIT_REPOSITORY https://github.com/zlib-ng/zlib-ng               GIT_TAG 2.2.5                                   GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(luajit        GIT_REPOSITORY https://github.com/SteamClientHomebrew/LuaJIT    GIT_TAG v2.1              SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(lua_cjson     GIT_REPOSITORY https://github.com/SteamClientHomebrew/LuaJSON   GIT_TAG master            SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(minhook       GIT_REPOSITORY https://github.com/TsudaKageyu/minhook           GIT_TAG v1.3.4            SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(mini          GIT_REPOSITORY https://github.com/metayeti/mINI                 GIT_TAG 0.9.18            SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(websocketpp   GIT_REPOSITORY https://github.com/zaphoyd/websocketpp           GIT_TAG 0.8.2             SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(fmt           GIT_REPOSITORY https://github.com/fmtlib/fmt                    GIT_TAG 12.0.0            SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(nlohmann_json GIT_REPOSITORY https://github.com/nlohmann/json                 GIT_TAG v3.12.0           SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(libgit2       GIT_REPOSITORY https://github.com/libgit2/libgit2               GIT_TAG v1.9.1            SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(minizip_ng    GIT_REPOSITORY https://github.com/zlib-ng/minizip-ng            GIT_TAG 4.0.10            SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(curl          GIT_REPOSITORY https://github.com/curl/curl                     GIT_TAG curl-8_13_0       SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(incbin        GIT_REPOSITORY https://github.com/graphitemaster/incbin         GIT_TAG main              SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)
FetchContent_Declare(asio          GIT_REPOSITORY https://github.com/chriskohlhoff/asio            GIT_TAG asio-1-30-0       SOURCE_SUBDIR fakedir GIT_SHALLOW TRUE GIT_PROGRESS TRUE)

set(DEPENDENCIES zlib luajit incbin websocketpp fmt nlohmann_json minizip_ng libgit2 mINI lua_cjson curl asio)

if(WIN32)
    list(APPEND DEPENDENCIES minhook)
endif()

foreach(dep ${DEPENDENCIES})
    string(TIMESTAMP start_time "%s")
    FetchContent_MakeAvailable(${dep})
    string(TIMESTAMP end_time "%s")
    math(EXPR duration "${end_time} - ${start_time}")
    message(STATUS "[Millennium] ${dep} completed in ${duration} seconds")
endforeach()

set(LUA_INCLUDE_DIR  luajit::header)
set(LUA_INCLUDE_DIRS luajit::header)
set(LUA_LIBRARY      luajit::lib   )
set(LUA_LIBRARIES    luajit::lib   )

include_directories("${libgit2_SOURCE_DIR}/include")
include_directories("${minizip_ng_SOURCE_DIR}")
include_directories("${incbin_SOURCE_DIR}")
include_directories("${asio_SOURCE_DIR}/asio/include")
include_directories("${luajit_BINARY_DIR}")
include_directories("${luajit_SOURCE_DIR}/src")
include_directories("${CMAKE_SOURCE_DIR}/../hhx64/include")

millennium_process_package("${luajit_SOURCE_DIR}")
millennium_process_package("${curl_SOURCE_DIR}")
millennium_process_package("${websocketpp_SOURCE_DIR}")
millennium_process_package("${fmt_SOURCE_DIR}")
millennium_process_package("${nlohmann_json_SOURCE_DIR}")
millennium_process_package("${libgit2_SOURCE_DIR}")
millennium_process_package("${minizip_ng_SOURCE_DIR}")
millennium_process_package("${mini_SOURCE_DIR}")
millennium_process_package("${lua_cjson_SOURCE_DIR}")

if(WIN32)
    millennium_process_package("${minhook_SOURCE_DIR}/")
endif()

set(ZLIB_ROOT "${zlib_BINARY_DIR}")
set(ZLIB_FOUND TRUE)
if(WIN32)
    if(CMAKE_BUILD_TYPE STREQUAL "Debug")
        set(ZLIB_LIBRARY "${zlib_BINARY_DIR}/zlibstaticd${CMAKE_STATIC_LIBRARY_SUFFIX}")
    else()
        set(ZLIB_LIBRARY "${zlib_BINARY_DIR}/zlibstatic${CMAKE_STATIC_LIBRARY_SUFFIX}")
    endif()
elseif(UNIX)
    set(ZLIB_LIBRARY "${zlib_BINARY_DIR}/libz${CMAKE_STATIC_LIBRARY_SUFFIX}")
endif()

set(ZLIB_LIBRARIES "${ZLIB_LIBRARY}")
set(ZLIB_INCLUDE_DIRS "${zlib_SOURCE_DIR};${zlib_BINARY_DIR}")
set(ZLIB_INCLUDE_DIR "${zlib_SOURCE_DIR};${zlib_BINARY_DIR}")

add_subdirectory("${luajit_SOURCE_DIR}"        "${luajit_BINARY_DIR}"       )
add_subdirectory("${curl_SOURCE_DIR}"          "${curl_BINARY_DIR}"         )
add_subdirectory("${websocketpp_SOURCE_DIR}"   "${websocketpp_BINARY_DIR}"  )
add_subdirectory("${fmt_SOURCE_DIR}"           "${fmt_BINARY_DIR}"          )
add_subdirectory("${nlohmann_json_SOURCE_DIR}" "${nlohmann_json_BINARY_DIR}")
add_subdirectory("${libgit2_SOURCE_DIR}"       "${libgit2_BINARY_DIR}"      )
add_subdirectory("${minizip_ng_SOURCE_DIR}"    "${minizip_ng_BINARY_DIR}"   )
add_subdirectory("${mini_SOURCE_DIR}"          "${mini_BINARY_DIR}"         )
add_subdirectory("${lua_cjson_SOURCE_DIR}"     "${lua_cjson_BINARY_DIR}"    )

if(WIN32)
    add_subdirectory("${minhook_SOURCE_DIR}"       "${minhook_BINARY_DIR}"      )
endif()

add_dependencies(cjson luajit::lib luajit::header)
add_dependencies(luajit zlib)
add_dependencies(minizip zlib)
